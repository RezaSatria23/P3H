<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Tambah UMKM - Halal UMKM Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c786c;    /* Hijau tua */
            --secondary: #004445;  /* Hijau lebih gelap */
            --accent: #f8b400;     /* Kuning keemasan */
            --light: #faf5e4;      /* Krem muda */
            --dark: #333;          /* Hitam */
            --success: #28a745;    /* Hijau */
            --warning: #ffc107;    /* Kuning */
            --danger: #dc3545;     /* Merah */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light); /* Warna latar krem (faf5e4) */
            color: var(--dark);
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: var(--secondary); /* Hijau gelap */
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(44, 120, 108, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        /* Status Options (Sesuai Web Utama) */
        .status-options {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .status-option {
            flex: 1;
            min-width: 120px;
        }

        .status-option input {
            display: none;
        }

        .status-option label {
            display: block;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
        }

        .status-option input:checked + label {
            border-color: var(--primary);
            background-color: rgba(44, 120, 108, 0.1);
        }

        /* Warna Status Spesifik */
        .status-option.certified input:checked + label {
            border-color: var(--success);
            background-color: rgba(40, 167, 69, 0.1);
        }

        .status-option.process input:checked + label {
            border-color: var(--warning);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .status-option.not-certified input:checked + label {
            border-color: var(--danger);
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Additional Forms */
        .additional-form {
            display: none;
            background-color: rgba(250, 245, 228, 0.5);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #eee;
        }

        /* Map Preview */
        .map-preview {
            height: 200px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            overflow: hidden;
        }

        .map-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Success Message */
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message i {
            color: var(--success);
        }

        /* Back Link */
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: var(--secondary);
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .status-options {
                flex-direction: column;
            }
            
            .status-option {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-plus-circle"></i> Tambah Data UMKM Baru</h1>
        
        <div class="success-message" id="success-message">
            <i class="fas fa-check-circle"></i> Data UMKM berhasil disimpan!
        </div>
        
        <form id="umkm-form">
            <div class="form-group">
                <label for="nama-umkm">Nama UMKM</label>
                <input type="text" id="nama-umkm" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="pemilik">Nama Pemilik</label>
                <input type="text" id="pemilik" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="jenis-produk">Jenis Produk</label>
                <select id="jenis-produk" class="form-control" required>
                    <option value="">Pilih Jenis Produk</option>
                    <option value="makanan">Makanan</option>
                    <option value="minuman">Minuman</option>
                    <option value="makanan-minuman">Makanan & Minuman</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Status Sertifikasi Halal</label>
                <div class="status-options">
                    <div class="status-option certified">
                        <input type="radio" name="status-halal" id="status-certified" value="certified">
                        <label for="status-certified">
                            <i class="fas fa-certificate"></i><br>
                            Sudah Bersertifikat
                        </label>
                    </div>
                    <div class="status-option process">
                        <input type="radio" name="status-halal" id="status-process" value="process">
                        <label for="status-process">
                            <i class="fas fa-spinner"></i><br>
                            Dalam Proses
                        </label>
                    </div>
                    <div class="status-option not-certified">
                        <input type="radio" name="status-halal" id="status-not-certified" value="not-certified">
                        <label for="status-not-certified">
                            <i class="fas fa-times-circle"></i><br>
                            Belum
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Form tambahan untuk status "Belum" -->
            <div id="belum-form" class="additional-form">
                <div class="form-group">
                    <label for="nama-produk">Nama Produk</label>
                    <input type="text" id="nama-produk" class="form-control">
                </div>
                <div class="form-group">
                    <label for="nib">Nomor Induk Berusaha (NIB)</label>
                    <input type="text" id="nib" class="form-control">
                </div>
                <div class="form-group">
                    <label for="kbli">Nomor KBLI</label>
                    <input type="text" id="kbli" class="form-control">
                </div>
            </div>

            <!-- Form tambahan untuk status "Dalam Proses" -->
            <div id="proses-form" class="additional-form">
                <div class="form-group">
                    <label for="nomor-sh">Nomor SH</label>
                    <input type="text" id="nomor-sh" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label for="provinsi">Provinsi</label>
                <select id="provinsi" class="form-control" required>
                    <option value="">Pilih Provinsi</option>
                    <!-- Provinsi akan diisi oleh JavaScript -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="kabupaten">Kabupaten/Kota</label>
                <select id="kabupaten" class="form-control" required disabled>
                    <option value="">Pilih Kabupaten/Kota</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="kecamatan">Kecamatan</label>
                <select id="kecamatan" class="form-control" required disabled>
                    <option value="">Pilih Kecamatan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="kelurahan">Kelurahan</label>
                <select id="kelurahan" class="form-control" required disabled>
                    <option value="">Pilih Kelurahan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="alamat">Alamat Lengkap</label>
                <textarea id="alamat" class="form-control" rows="3" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="maps">Link Google Maps</label>
                <input type="text" id="maps" class="form-control" placeholder="Masukkan koordinat (contoh: -6.12345,106.12345) atau alamat">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Anda bisa memasukkan koordinat (contoh: -6.12345,106.12345) atau alamat lengkap
                </small>
                <div class="map-preview" id="map-preview">
                    <div>
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Pratinjau peta akan muncul di sini</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="keterangan">Keterangan Tambahan</label>
                <textarea id="keterangan" class="form-control" rows="3"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-save"></i> Simpan Data UMKM
            </button>
        </form>
        
        <a href="index.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
        </a>
    </div>

    <script>
        // Data Storage
        let umkmData = JSON.parse(localStorage.getItem('umkmData')) || [];
        let provincesData = [];
        let regenciesData = [];
        let districtsData = [];
        let villagesData = [];

        // DOM Elements
        const umkmForm = document.getElementById('umkm-form');
        const successMessage = document.getElementById('success-message');

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            initRegionDropdowns();
            initEventListeners();
        });

        // Fungsi untuk mengambil data dari API
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        // Inisialisasi dropdown wilayah
        async function initRegionDropdowns() {
            // Isi data provinsi
            provincesData = await fetchData('https://www.emsifa.com/api-wilayah-indonesia/api/provinces.json');
            const provinceDropdown = document.getElementById('provinsi');
            
            provinceDropdown.innerHTML = '<option value="">Pilih Provinsi</option>';
            provincesData.forEach(province => {
                provinceDropdown.innerHTML += `<option value="${province.id}">${province.name}</option>`;
            });
            
            // Event listener untuk provinsi
            provinceDropdown.addEventListener('change', async function() {
                const provinceId = this.value;
                const regencyDropdown = document.getElementById('kabupaten');
                
                regencyDropdown.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                regencyDropdown.disabled = !provinceId;
                
                if (provinceId) {
                    regenciesData = await fetchData(`https://www.emsifa.com/api-wilayah-indonesia/api/regencies/${provinceId}.json`);
                    regenciesData.forEach(regency => {
                        regencyDropdown.innerHTML += `<option value="${regency.id}">${regency.name}</option>`;
                    });
                    regencyDropdown.disabled = false;
                }
                
                // Reset dropdown kecamatan dan kelurahan
                document.getElementById('kecamatan').innerHTML = '<option value="">Pilih Kecamatan</option>';
                document.getElementById('kecamatan').disabled = true;
                document.getElementById('kelurahan').innerHTML = '<option value="">Pilih Kelurahan</option>';
                document.getElementById('kelurahan').disabled = true;
            });
            
            // Event listener untuk kabupaten/kota
            document.getElementById('kabupaten').addEventListener('change', async function() {
                const regencyId = this.value;
                const districtDropdown = document.getElementById('kecamatan');
                
                districtDropdown.innerHTML = '<option value="">Pilih Kecamatan</option>';
                districtDropdown.disabled = !regencyId;
                
                if (regencyId) {
                    districtsData = await fetchData(`https://www.emsifa.com/api-wilayah-indonesia/api/districts/${regencyId}.json`);
                    districtsData.forEach(district => {
                        districtDropdown.innerHTML += `<option value="${district.id}">${district.name}</option>`;
                    });
                    districtDropdown.disabled = false;
                }
                
                // Reset dropdown kelurahan
                document.getElementById('kelurahan').innerHTML = '<option value="">Pilih Kelurahan</option>';
                document.getElementById('kelurahan').disabled = true;
            });
            
            // Event listener untuk kecamatan
            document.getElementById('kecamatan').addEventListener('change', async function() {
                const districtId = this.value;
                const villageDropdown = document.getElementById('kelurahan');
                
                villageDropdown.innerHTML = '<option value="">Pilih Kelurahan</option>';
                villageDropdown.disabled = !districtId;
                
                if (districtId) {
                    villagesData = await fetchData(`https://www.emsifa.com/api-wilayah-indonesia/api/villages/${districtId}.json`);
                    villagesData.forEach(village => {
                        villageDropdown.innerHTML += `<option value="${village.id}">${village.name}</option>`;
                    });
                    villageDropdown.disabled = false;
                }
            });
        }

        // Initialize event listeners
        function initEventListeners() {
            // Form submission
            umkmForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUmkm();
            });
            
            // Status radio buttons
            document.querySelectorAll('input[name="status-halal"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleAdditionalForms(this.value);
                });
            });
            
            // Map preview
            document.getElementById('maps').addEventListener('input', function() {
                updateMapPreview(this.value);
            });
        }

        // Toggle additional forms based on status
        function toggleAdditionalForms(status) {
            const belumForm = document.getElementById('belum-form');
            const prosesForm = document.getElementById('proses-form');
            
            // Hide all additional forms first
            belumForm.style.display = 'none';
            prosesForm.style.display = 'none';
            
            // Show form based on status
            if (status === 'not-certified') {
                belumForm.style.display = 'block';
            } else if (status === 'process') {
                prosesForm.style.display = 'block';
            }
        }

        // Update map preview
        function updateMapPreview(mapInput) {
            const mapPreview = document.getElementById('map-preview');
            
            if (mapInput) {
                // Extract coordinates or address from input
                let embedUrl;
                
                // If it's a coordinate (format: -6.12345,106.12345 or @-6.12345,106.12345)
                if (mapInput.match(/@?[-+]?[0-9]*\.?[0-9]+,[-+]?[0-9]*\.?[0-9]+/)) {
                    // Clean the coordinate (remove @ if exists)
                    const cleanCoords = mapInput.replace('@', '');
                    embedUrl = `https://maps.google.com/maps?q=${cleanCoords}&output=embed`;
                } else {
                    // Assume it's an address
                    embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(mapInput)}&output=embed`;
                }
                
                mapPreview.innerHTML = `
                    <iframe 
                        src="${embedUrl}" 
                        width="100%" 
                        height="100%" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy">
                    </iframe>
                `;
            } else {
                mapPreview.innerHTML = `
                    <div>
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Pratinjau peta akan muncul di sini</p>
                    </div>
                `;
            }
        }

        // Save UMKM data
        function saveUmkm() {
            const nama = document.getElementById('nama-umkm').value;
            const pemilik = document.getElementById('pemilik').value;
            const jenisProduk = document.getElementById('jenis-produk').value;
            const provinsiId = document.getElementById('provinsi').value;
            const provinsiName = document.getElementById('provinsi').options[document.getElementById('provinsi').selectedIndex].text;
            const kabupatenId = document.getElementById('kabupaten').value;
            const kabupatenName = document.getElementById('kabupaten').options[document.getElementById('kabupaten').selectedIndex].text;
            const kecamatanId = document.getElementById('kecamatan').value;
            const kecamatanName = document.getElementById('kecamatan').options[document.getElementById('kecamatan').selectedIndex].text;
            const kelurahanId = document.getElementById('kelurahan').value;
            const kelurahanName = document.getElementById('kelurahan').options[document.getElementById('kelurahan').selectedIndex].text;
            const alamat = document.getElementById('alamat').value;
            const maps = document.getElementById('maps').value;
            const status = document.querySelector('input[name="status-halal"]:checked')?.value;
            const keterangan = document.getElementById('keterangan').value;

            // Get values from additional forms based on status
            const namaProduk = document.getElementById('nama-produk')?.value || '';
            const nib = document.getElementById('nib')?.value || '';
            const kbli = document.getElementById('kbli')?.value || '';
            const nomorSh = document.getElementById('nomor-sh')?.value || '';
            
            // Validate required fields
            if (!nama || !pemilik || !jenisProduk || !provinsiId || !kabupatenId || !kecamatanId || !kelurahanId || !alamat || !status) {
                alert('Harap isi semua field yang wajib diisi!');
                return;
            }
            
            // Create new UMKM ID
            const newId = umkmData.length > 0 ? Math.max(...umkmData.map(u => u.id)) + 1 : 1;
            const today = new Date().toISOString().split('T')[0];
            
            // Format maps link
            let mapsValue = '';
            if (maps) {
                if (maps.match(/@?[-+]?[0-9]*\.?[0-9]+,[-+]?[0-9]*\.?[0-9]+/)) {
                    // Clean the coordinate (remove @ if exists)
                    const cleanCoords = maps.replace('@', '');
                    mapsValue = `https://www.google.com/maps?q=${cleanCoords}`;
                } else {
                    // Assume it's an address or link
                    mapsValue = maps;
                }
            }
            
            // Create UMKM object
            const newUmkm = {
                id: newId,
                nama,
                pemilik,
                jenisProduk,
                sh: status === 'certified' || status === 'process' ? nomorSh : '',
                provinsi: { id: provinsiId, name: provinsiName },
                kabupaten: { id: kabupatenId, name: kabupatenName },
                kecamatan: { id: kecamatanId, name: kecamatanName },
                kelurahan: { id: kelurahanId, name: kelurahanName },
                alamat,
                maps: mapsValue,
                status,
                keterangan,
                namaProduk: status === 'not-certified' ? namaProduk : '',
                nib: status === 'not-certified' ? nib : '',
                kbli: status === 'not-certified' ? kbli : '',
                tanggalDaftar: today
            };
            
            // Add to data array
            umkmData.push(newUmkm);
            
            // Save to localStorage
            localStorage.setItem('umkmData', JSON.stringify(umkmData));
            
            // Show success message
            successMessage.style.display = 'block';
            
            // Reset form after 2 seconds
            setTimeout(() => {
                umkmForm.reset();
                successMessage.style.display = 'none';
                
                // Reset region dropdowns
                document.getElementById('provinsi').value = '';
                document.getElementById('kabupaten').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                document.getElementById('kabupaten').disabled = true;
                document.getElementById('kecamatan').innerHTML = '<option value="">Pilih Kecamatan</option>';
                document.getElementById('kecamatan').disabled = true;
                document.getElementById('kelurahan').innerHTML = '<option value="">Pilih Kelurahan</option>';
                document.getElementById('kelurahan').disabled = true;
                
                // Reset status radio buttons
                document.querySelectorAll('input[name="status-halal"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Hide additional forms
                document.getElementById('belum-form').style.display = 'none';
                document.getElementById('proses-form').style.display = 'none';
                
                // Reset map preview
                document.getElementById('map-preview').innerHTML = `
                    <div>
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Pratinjau peta akan muncul di sini</p>
                    </div>
                `;
            }, 2000);
        }
    </script>
</body>
</html>